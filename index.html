<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒØ§ÙØªÙŠØ±ÙŠØ§ Ø§Ù„Ø®ÙŠØ±</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="stylesheet" href="styles.css">
    <script defer src="app-part1.js"></script>
</head>
<body>
    <!-- Hero Section -->
    <section class="hero-section">
        <h1 id="heroTitle"></h1>
        <p id="heroDescription"></p>
    </section>

    <!-- Categories -->
    <section id="categoriesGrid" class="categories-grid"></section>

    <!-- Top Products -->
    <section id="topProductsGrid" class="top-products-grid"></section>

    <!-- Product Filters -->
    <section id="productsFilter" class="filter-buttons"></section>

    <!-- Products -->
    <section id="productsGrid" class="products-grid"></section>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div id="cartItems"></div>
        <div id="cartTotalPrice"></div>
        <button onclick="checkout()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
    </div>

    <!-- Admin Panel Button -->
    <button id="adminFloatingBtn" style="display:none;" onclick="document.getElementById('adminPanel').classList.toggle('active')">
        Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    </button>

    <script>
    // ===== CONSTANTS & CONFIGURATION =====
    const ADMIN_CREDENTIALS = { username: "admin", password: "admin123" };
    const STORAGE_KEYS = {
        PRODUCTS: 'kafeteria_products_v4',
        CATEGORIES: 'kafeteria_categories_v4',
        TOP_PRODUCTS: 'kafeteria_top_products_v4',
        ORDERS: 'kafeteria_orders_v4',
        CART: 'kafeteria_cart_v4',
        SETTINGS: 'kafeteria_settings_v4',
        HERO: 'kafeteria_hero_v4',
        IMAGES: 'kafeteria_images_v4',
        ADMIN_TOKEN: 'kafeteria_admin_token'
    };
    const DEFAULT_SETTINGS = {
        storeName: "ÙƒØ§ÙØªÙŠØ±ÙŠØ§ Ø§Ù„Ø®ÙŠØ±",
        storePhone: "+967730528609",
        storeAddress: "Ø§Ù„ÙŠÙ…Ù† â€“ ØªØ¹Ø² â€“ Ø¯Ù…Ù†Ø© Ø®Ø¯ÙŠØ± â€“ Ø§Ù„ÙƒÙ…Ø¨ - Ø£Ù…Ø§Ù… Ø§Ù„Ù…Ù„Ùƒ ÙÙˆÙ† â€“ Ø¬ÙˆØ§Ø± ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø¹ÙÙŠÙÙŠ",
        storeHours: "Ù…ÙØªÙˆØ­ 24 Ø³Ø§Ø¹Ø©",
        currency: "Ø±ÙŠØ§Ù„"
    };
    const DEFAULT_HERO = {
        title: "Ø§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ¬Ø±Ø¨Ø© Ø¹ØµØ§Ø¦Ø± ÙØ§Ø®Ø±Ø© Ù„Ø§ ØªÙÙ†Ø³Ù‰! ğŸ¹",
        description: "Ø§ÙƒØªØ´Ù Ø¹Ø§Ù„Ù…Ù‹Ø§ Ù…Ù† Ø§Ù„Ù†ÙƒÙ‡Ø§Øª Ø§Ù„Ø±Ø§Ù‚ÙŠØ© Ù…Ø¹ Ø¹ØµØ§Ø¦Ø±Ù†Ø§ Ø§Ù„Ø·Ø§Ø²Ø¬Ø© ÙˆØ³Ù†Ø¯ÙˆØªØ´Ø§ØªÙ†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²Ø© - Ø¬ÙˆØ¯Ø© Ù„Ø§ Ù…Ø«ÙŠÙ„ Ù„Ù‡Ø§!",
        backgroundImage: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80"
    };

    // ===== GLOBAL STATE =====
    let state = {
        products: [], categories: [], topProducts: [], cart: [], orders: [],
        settings: {}, hero: {}, images: {}, currentCategory: 'all',
        isAdmin: false, currentProductId: null, currentTopProductId: null
    };

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        renderAll();
    });

    function initializeApp() {
        // Check admin login status
        state.isAdmin = localStorage.getItem(STORAGE_KEYS.ADMIN_TOKEN) === 'logged_in';
        loadAllData();
        if(state.products.length===0) initializeSampleData();
        updateAdminUI();
    }

    function loadAllData() {
        try {
            state.products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
            state.categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
            state.topProducts = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOP_PRODUCTS)) || [];
            state.cart = JSON.parse(localStorage.getItem(STORAGE_KEYS.CART)) || [];
            state.orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
            state.settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS)) || { ...DEFAULT_SETTINGS };
            state.hero = JSON.parse(localStorage.getItem(STORAGE_KEYS.HERO)) || { ...DEFAULT_HERO };
            state.images = JSON.parse(localStorage.getItem(STORAGE_KEYS.IMAGES)) || {};
        } catch(e) {
            console.error('Error loading data', e);
        }
    }

    function saveAll() {
        localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(state.products));
        localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(state.categories));
        localStorage.setItem(STORAGE_KEYS.TOP_PRODUCTS, JSON.stringify(state.topProducts));
        localStorage.setItem(STORAGE_KEYS.CART, JSON.stringify(state.cart));
        localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(state.orders));
        localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(state.settings));
        localStorage.setItem(STORAGE_KEYS.HERO, JSON.stringify(state.hero));
        localStorage.setItem(STORAGE_KEYS.IMAGES, JSON.stringify(state.images));
    }

    function initializeSampleData() {
        state.categories = [
            { id:1,name:"Ø¹ØµØ§Ø¦Ø± ÙÙˆØ§ÙƒÙ‡",icon:"fas fa-glass-whiskey",productCount:0 },
            { id:2,name:"Ø³Ù…ÙˆØ«ÙŠØ²",icon:"fas fa-blender",productCount:0 },
            { id:3,name:"Ù…ÙŠÙ„Ùƒ Ø´ÙŠÙƒ",icon:"fas fa-ice-cream",productCount:0 },
            { id:4,name:"Ø³Ù†Ø¯ÙˆØªØ´Ø§Øª",icon:"fas fa-hamburger",productCount:0 }
        ];

        state.products = [
            { id:1,name:"Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ Ø·Ø§Ø²Ø¬",description:"Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ Ø·Ø¨ÙŠØ¹ÙŠ 100%",price:500,category:"Ø¹ØµØ§Ø¦Ø± ÙÙˆØ§ÙƒÙ‡",image:"https://images.unsplash.com/photo-1623065687346-7e23c4c2b19b?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",status:"available",createdAt:new Date().toISOString() }
        ];

        state.topProducts = [
            { id:1,name:"Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ ÙØ§Ø®Ø±",description:"Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ Ø·Ø¨ÙŠØ¹ÙŠ 100%",price:500,image:"https://images.unsplash.com/photo-1623065687346-7e23c4c2b19b?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" }
        ];

        updateCategoryCounts();
        saveAll();
    }

    function updateCategoryCounts() {
        state.categories.forEach(cat => {
            cat.productCount = state.products.filter(p=>p.category===cat.name && p.status==="available").length;
        });
    }

    function renderAll() {
        renderHero();
        renderCategories();
        renderTopProducts();
    }

    function renderHero() {
        document.getElementById('heroTitle').textContent = state.hero.title;
        document.getElementById('heroDescription').textContent = state.hero.description;
        document.querySelector('.hero-section').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)),url('${state.hero.backgroundImage}')`;
    }

    // PWA service worker registration
    if('serviceWorker' in navigator){
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</body>
</html>
// ===== RENDER CATEGORIES =====
function renderCategories() {
    const container = document.getElementById('categoriesGrid');
    container.innerHTML = '';
    state.categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'category-card';
        div.innerHTML = `
            <i class="${cat.icon}"></i>
            <h3>${cat.name}</h3>
            <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${cat.productCount}</span>
        `;
        div.onclick = () => {
            state.currentCategory = cat.name;
            renderProducts();
        };
        container.appendChild(div);
    });
}

// ===== RENDER TOP PRODUCTS =====
function renderTopProducts() {
    const container = document.getElementById('topProductsGrid');
    container.innerHTML = '';
    state.topProducts.forEach(prod => {
        const div = document.createElement('div');
        div.className = 'top-product-card';
        div.innerHTML = `
            <img src="${prod.image}" alt="${prod.name}">
            <h4>${prod.name}</h4>
            <p>${prod.description}</p>
            <span>${state.settings.currency} ${prod.price}</span>
            <button onclick="addToCart(${prod.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        `;
        container.appendChild(div);
    });
}

// ===== RENDER PRODUCTS =====
function renderProducts() {
    const container = document.getElementById('productsGrid');
    container.innerHTML = '';
    const filtered = state.products.filter(p => p.status === 'available' && 
        (state.currentCategory === 'all' || p.category === state.currentCategory));
    filtered.forEach(prod => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <img src="${prod.image}" alt="${prod.name}">
            <h4>${prod.name}</h4>
            <p>${prod.description}</p>
            <span>${state.settings.currency} ${prod.price}</span>
            <button onclick="addToCart(${prod.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        `;
        container.appendChild(div);
    });
}

// ===== CART FUNCTIONS =====
function addToCart(productId) {
    const product = state.products.find(p => p.id === productId);
    if (!product) return;
    const existing = state.cart.find(c => c.id === productId);
    if (existing) {
        existing.quantity += 1;
    } else {
        state.cart.push({...product, quantity:1});
    }
    saveAll();
    renderCart();
}

function removeFromCart(productId) {
    state.cart = state.cart.filter(c => c.id !== productId);
    saveAll();
    renderCart();
}

function renderCart() {
    const container = document.getElementById('cartItems');
    container.innerHTML = '';
    let total = 0;
    state.cart.forEach(item => {
        total += item.price * item.quantity;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
            <span>${item.name} x${item.quantity}</span>
            <span>${state.settings.currency} ${item.price * item.quantity}</span>
            <button onclick="removeFromCart(${item.id})">Ø­Ø°Ù</button>
        `;
        container.appendChild(div);
    });
    document.getElementById('cartTotalPrice').textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${state.settings.currency} ${total}`;
}

// ===== CHECKOUT VIA WHATSAPP =====
function checkout() {
    if(state.cart.length===0){
        alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
        return;
    }
    const orderLines = state.cart.map(i=>`${i.name} x${i.quantity} = ${state.settings.currency} ${i.price*i.quantity}`).join('\n');
    const totalPrice = state.cart.reduce((sum,i)=>sum+i.price*i.quantity,0);
    const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£ÙˆØ¯ Ø·Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ:\n${orderLines}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${state.settings.currency} ${totalPrice}`;
    const encodedMessage = encodeURIComponent(message);
    const whatsappLink = `https://wa.me/${state.settings.storePhone.replace(/\D/g,'')}?text=${encodedMessage}`;
    window.open(whatsappLink, '_blank');
}

// ===== ADMIN PANEL =====
function updateAdminUI() {
    const btn = document.getElementById('adminFloatingBtn');
    btn.style.display = state.isAdmin ? 'block' : 'none';
}

function loginAdmin(username, password) {
    if(username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password){
        state.isAdmin = true;
        localStorage.setItem(STORAGE_KEYS.ADMIN_TOKEN, 'logged_in');
        updateAdminUI();
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„');
    } else {
        alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    }
}

function logoutAdmin() {
    state.isAdmin = false;
    localStorage.removeItem(STORAGE_KEYS.ADMIN_TOKEN);
    updateAdminUI();
}

// ===== ADMIN CRUD =====
function addProduct(product) {
    const newId = Math.max(0,...state.products.map(p=>p.id)) +1;
    state.products.push({...product,id:newId,status:'available',createdAt:new Date().toISOString()});
    updateCategoryCounts();
    saveAll();
    renderProducts();
}

function updateProduct(productId, data) {
    const idx = state.products.findIndex(p=>p.id===productId);
    if(idx>-1){
        state.products[idx] = {...state.products[idx], ...data};
        updateCategoryCounts();
        saveAll();
        renderProducts();
    }
}

function deleteProduct(productId) {
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')){
        state.products = state.products.filter(p=>p.id!==productId);
        updateCategoryCounts();
        saveAll();
        renderProducts();
    }
}

// ===== PWA INSTALL PROMPT =====
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
});

function installPWA() {
    if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult=>{
            if(choiceResult.outcome==='accepted'){
                console.log('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
            }
            deferredPrompt = null;
        });
    }
}

// ===== INIT =====
renderProducts();
renderCart();
